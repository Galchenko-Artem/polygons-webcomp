(()=>{const t="http://www.w3.org/2000/svg";class e extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const e=JSON.parse(this.dataset.points),n=document.createElementNS(t,"svg");n.setAttribute("width",80),n.setAttribute("height",80);const o=document.createElementNS(t,"polygon");o.setAttribute("points",e.map(t=>t.join(",")).join(" ")),o.setAttribute("fill","var(--accent)"),n.append(o),this.shadowRoot.append(n),this.draggable=!0,this.addEventListener("dragstart",t=>{t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("application/json",this.dataset.points),c=this.closest("foreignObject")||this})}}customElements.define("poly-item",e);const n=t=>document.getElementById(t),o=n("buffer-zone"),r=n("work-zone"),a=n("work-svg"),s=n("grid"),i=n("viewport");let c=null;function l(){const t=3+Math.floor(5*Math.random()),e=[];for(let n=0;n<t;n++){const o=2*Math.PI/t*n+.5*Math.random(),r=20+15*Math.random();e.push([40+Math.cos(o)*r,40+Math.sin(o)*r])}return e}function d(){o.replaceChildren();const t=5+Math.floor(16*Math.random());for(let e=0;e<t;e++){const t=document.createElement("poly-item");t.dataset.points=JSON.stringify(l()),o.append(t)}E()}[o,r].forEach(t=>t.addEventListener("dragover",t=>t.preventDefault())),o.addEventListener("drop",t=>{t.preventDefault(),c&&(o.append("poly-item"===c.nodeName?c:c.firstElementChild),c.remove(),E(),c=null)}),r.addEventListener("drop",e=>{e.preventDefault();const n=e.dataTransfer.getData("application/json");if(!n)return;const o=a.createSVGPoint();o.x=e.clientX,o.y=e.clientY;const r=o.matrixTransform(i.getScreenCTM().inverse()),s=document.createElementNS(t,"foreignObject");s.setAttribute("x",r.x-40),s.setAttribute("y",r.y-40),s.setAttribute("width",80),s.setAttribute("height",80);const l=document.createElement("poly-item");l.dataset.points=n,s.append(l),i.append(s),c?.remove(),E(),c=null});let p=1,u=0,m=0,f=!1,h=0,b=0;function g(){s.replaceChildren();const t=40*p,e=a.clientWidth,n=a.clientHeight,o=(-m%t+t)%t;for(let o=(-u%t+t)%t,r=0;o<=e;o+=t,r++)v(o,0,o,n),y(o+2,n-4,10*r);for(let r=o,a=0;r<=n;r+=t,a++)v(0,r,e,r),y(2,r-2,10*a)}function v(e,n,o,r){const a=document.createElementNS(t,"line");a.setAttribute("x1",e),a.setAttribute("y1",n),a.setAttribute("x2",o),a.setAttribute("y2",r),a.setAttribute("stroke","var(--grid)"),s.append(a)}function y(e,n,o){const r=document.createElementNS(t,"text");r.textContent=o,r.setAttribute("x",e),r.setAttribute("y",n),r.setAttribute("font-size",10),r.setAttribute("fill","var(--text)"),s.append(r)}function A(){i.setAttribute("transform",`translate(${u},${m}) scale(${p})`),g()}function E(){const t=[...o.children].map(t=>t.dataset.points),e=[...i.querySelectorAll("poly-item")].map(t=>{const e=t.closest("foreignObject");return{p:t.dataset.points,x:+e.getAttribute("x"),y:+e.getAttribute("y")}});localStorage.setItem("polygons",JSON.stringify({buf:t,wrk:e,scale:p,ox:u,oy:m}))}a.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1,n=p;p=Math.max(.2,Math.min(3,p*e));const o=a.getBoundingClientRect(),r=t.clientX-o.left,s=t.clientY-o.top;u=r-(r-u)*p/n,m=s-(s-m)*p/n,A()}),a.addEventListener("mousedown",t=>{0===t.button&&(f=!0,h=t.clientX,b=t.clientY)}),window.addEventListener("mousemove",t=>{f&&(u+=t.clientX-h,m+=t.clientY-b,h=t.clientX,b=t.clientY,A())}),window.addEventListener("mouseup",()=>f=!1),window.addEventListener("load",()=>{n("create-btn").onclick=d,n("save-btn").onclick=E,n("reset-btn").onclick=()=>{localStorage.removeItem("polygons"),location.reload()},g(),function(){const e=localStorage.getItem("polygons");if(e)try{const{buf:n,wrk:r,scale:a,ox:s,oy:c}=JSON.parse(e);n.forEach(t=>function(t){const e=document.createElement("poly-item");e.dataset.points=t,o.append(e)}(t)),r.forEach(({p:e,x:n,y:o})=>{const r=document.createElementNS(t,"foreignObject");r.setAttribute("x",n),r.setAttribute("y",o),r.setAttribute("width",80),r.setAttribute("height",80);const a=document.createElement("poly-item");a.dataset.points=e,r.append(a),i.append(r)}),p=a,u=s,m=c,A()}catch(t){console.warn("restore error",t)}}()})})();