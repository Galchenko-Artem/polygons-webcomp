(()=>{const t="http://www.w3.org/2000/svg";class e extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const e=JSON.parse(this.dataset.points),n=document.createElementNS(t,"svg");n.setAttribute("width",80),n.setAttribute("height",80);const o=document.createElementNS(t,"polygon");o.setAttribute("points",e.map(t=>t.join(",")).join(" ")),o.setAttribute("fill","var(--accent)"),n.append(o),this.shadowRoot.append(n),this.draggable=!0,this.addEventListener("dragstart",t=>{t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("application/json",this.dataset.points),c=this.closest("foreignObject")||this})}}customElements.define("poly-item",e);const n=t=>document.getElementById(t),o=n("buffer-zone"),r=n("work-zone"),a=n("work-svg"),i=n("grid"),s=n("viewport");let c=null;function l(){const t=3+Math.floor(5*Math.random()),e=[];for(let n=0;n<t;n++){const o=2*Math.PI/t*n+.5*Math.random(),r=20+15*Math.random();e.push([40+Math.cos(o)*r,40+Math.sin(o)*r])}return e}function d(){o.replaceChildren();const t=5+Math.floor(16*Math.random());for(let e=0;e<t;e++){const t=document.createElement("poly-item");t.dataset.points=JSON.stringify(l()),o.append(t)}A()}[o,r].forEach(t=>t.addEventListener("dragover",t=>t.preventDefault())),o.addEventListener("drop",t=>{t.preventDefault(),c&&(o.append("poly-item"===c.nodeName?c:c.firstElementChild),c.remove(),A(),c=null)}),r.addEventListener("drop",e=>{e.preventDefault();const n=e.dataTransfer.getData("application/json");if(!n)return;const o=a.createSVGPoint();o.x=e.clientX,o.y=e.clientY;const r=o.matrixTransform(s.getScreenCTM().inverse()),i=document.createElementNS(t,"foreignObject");i.setAttribute("x",r.x-40),i.setAttribute("y",r.y-40),i.setAttribute("width",80),i.setAttribute("height",80);const l=document.createElement("poly-item");l.dataset.points=n,i.append(l),s.append(i),c?.remove(),A(),c=null});let u=1,p=0,m=0,f=!1,h=0,g=0;function b(){i.replaceChildren();const t=40*u,e=a.clientWidth,n=a.clientHeight,o=(-m%t+t)%t;for(let o=(-p%t+t)%t,r=0;o<=e;o+=t,r++)v(o,0,o,n),y(o+2,n-4,10*r);for(let r=o,a=0;r<=n;r+=t,a++)v(0,r,e,r),y(2,r-2,10*a)}function v(e,n,o,r){const a=document.createElementNS(t,"line");a.setAttribute("x1",e),a.setAttribute("y1",n),a.setAttribute("x2",o),a.setAttribute("y2",r),a.setAttribute("stroke","var(--grid)"),i.append(a)}function y(e,n,o){const r=document.createElementNS(t,"text");r.textContent=o,r.setAttribute("x",e),r.setAttribute("y",n),r.setAttribute("font-size",10),r.setAttribute("fill","var(--text)"),i.append(r)}function E(){s.setAttribute("transform",`translate(${p},${m}) scale(${u})`),b()}function A(){const t=Array.from(o.children,t=>t.dataset.points),e=Array.from(s.querySelectorAll("foreignObject"),t=>({p:t.firstElementChild.dataset.points,x:t.getAttribute("x"),y:t.getAttribute("y")}));localStorage.setItem("polygons",JSON.stringify({buf:t,wrk:e,scale:u,ox:p,oy:m}))}a.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1,n=u;u=Math.max(.2,Math.min(3,u*e));const o=a.getBoundingClientRect(),r=t.clientX-o.left,i=t.clientY-o.top;p=r-(r-p)*u/n,m=i-(i-m)*u/n,E()}),a.addEventListener("mousedown",t=>{0===t.button&&(f=!0,h=t.clientX,g=t.clientY)}),window.addEventListener("mousemove",t=>{f&&(p+=t.clientX-h,m+=t.clientY-g,h=t.clientX,g=t.clientY,E())}),window.addEventListener("mouseup",()=>f=!1),window.addEventListener("load",()=>{n("create-btn").onclick=d,n("save-btn").onclick=A,n("reset-btn").onclick=()=>{localStorage.removeItem("polygons"),location.reload()},b(),function(){const t=localStorage.getItem("polygons");if(t)try{const{buf:e,wrk:n,scale:r,ox:a,oy:i}=JSON.parse(t);e.forEach(t=>function(t){const e=document.createElement("poly-item");e.dataset.points=t,o.append(e)}(t)),n.forEach(({p:t,x:e,y:n})=>addPolyToWork(t,+e+40,+n+40)),u=r,p=a,m=i,E()}catch(t){console.warn("restore error",t)}}()})})();