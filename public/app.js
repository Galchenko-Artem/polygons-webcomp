(()=>{const t="http://www.w3.org/2000/svg";class e extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const e=JSON.parse(this.dataset.points),n=document.createElementNS(t,"svg");n.setAttribute("width",80),n.setAttribute("height",80);const o=document.createElementNS(t,"polygon");o.setAttribute("points",e.map(t=>t.join(",")).join(" ")),o.setAttribute("fill","var(--accent)"),n.append(o),this.shadowRoot.append(n),this.draggable=!0,this.addEventListener("dragstart",t=>{t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("application/json",this.dataset.points),c=this.closest("foreignObject")||this})}}customElements.define("poly-item",e);const n=t=>document.getElementById(t),o=n("buffer-zone"),a=n("work-zone"),r=n("work-svg"),i=n("grid"),s=n("viewport");let c=null;function l(){const t=3+Math.floor(5*Math.random()),e=[];for(let n=0;n<t;n++){const o=2*Math.PI/t*n+.5*Math.random(),a=20+15*Math.random();e.push([40+Math.cos(o)*a,40+Math.sin(o)*a])}return e}function d(){o.replaceChildren();const t=5+Math.floor(16*Math.random());for(let e=0;e<t;e++){const t=document.createElement("poly-item");t.dataset.points=JSON.stringify(l()),o.append(t)}w()}[o,a].forEach(t=>t.addEventListener("dragover",t=>t.preventDefault())),o.addEventListener("drop",t=>{t.preventDefault(),c&&(o.append("poly-item"===c.nodeName?c:c.firstElementChild),c.remove(),w(),c=null)}),a.addEventListener("drop",e=>{e.preventDefault();const n=e.dataTransfer.getData("application/json");if(!n)return;const o=r.createSVGPoint();o.x=e.clientX,o.y=e.clientY;const a=o.matrixTransform(s.getScreenCTM().inverse()),i=document.createElementNS(t,"foreignObject");i.setAttribute("x",a.x-40),i.setAttribute("y",a.y-40),i.setAttribute("width",80),i.setAttribute("height",80);const l=document.createElement("poly-item");l.dataset.points=n,i.append(l),s.append(i),c?.remove(),w(),c=null});let p=1,u=0,m=0,f=!1,h=0,g=0;function b(){i.replaceChildren();const t=40*p,e=r.clientWidth,n=r.clientHeight,o=(-m%t+t)%t;for(let o=(-u%t+t)%t,a=0;o<=e;o+=t,a++)v(o,0,o,n),y(o+2,n-4,10*a);for(let a=o,r=0;a<=n;a+=t,r++)v(0,a,e,a),y(2,a-2,10*r)}function v(e,n,o,a){const r=document.createElementNS(t,"line");r.setAttribute("x1",e),r.setAttribute("y1",n),r.setAttribute("x2",o),r.setAttribute("y2",a),r.setAttribute("stroke","var(--grid)"),i.append(r)}function y(e,n,o){const a=document.createElementNS(t,"text");a.textContent=o,a.setAttribute("x",e),a.setAttribute("y",n),a.setAttribute("font-size",10),a.setAttribute("fill","var(--text)"),i.append(a)}function E(){s.setAttribute("transform",`translate(${u},${m}) scale(${p})`),b()}function w(){const t=[...o.children].map(t=>t.dataset.points),e=[...s.children].map(t=>({p:t.firstElementChild.dataset.points,x:t.getAttribute("x"),y:t.getAttribute("y")}));localStorage.setItem("polygons",JSON.stringify({buf:t,wrk:e,scale:p,ox:u,oy:m}))}r.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?.9:1.1,n=p;p=Math.max(.2,Math.min(3,p*e));const o=r.getBoundingClientRect(),a=t.clientX-o.left,i=t.clientY-o.top;u=a-(a-u)*p/n,m=i-(i-m)*p/n,E()}),r.addEventListener("mousedown",t=>{0===t.button&&(f=!0,h=t.clientX,g=t.clientY)}),window.addEventListener("mousemove",t=>{f&&(u+=t.clientX-h,m+=t.clientY-g,h=t.clientX,g=t.clientY,E())}),window.addEventListener("mouseup",()=>f=!1),window.addEventListener("load",()=>{n("create-btn").onclick=d,n("save-btn").onclick=w,n("reset-btn").onclick=()=>{localStorage.removeItem("polygons"),location.reload()},b(),function(){const t=localStorage.getItem("polygons");if(t)try{const{buf:e,wrk:n,scale:a,ox:r,oy:i}=JSON.parse(t);e.forEach(t=>function(t){const e=document.createElement("poly-item");e.dataset.points=t,o.append(e)}(t)),n.forEach(t=>addPolyToWork(t.p,+t.x+40,+t.y+40)),p=a,u=r,m=i,E()}catch(t){console.warn("restore error",t)}}()})})();